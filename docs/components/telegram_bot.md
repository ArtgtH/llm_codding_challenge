# Компонент Telegram-бот

Компонент Telegram-бот отвечает за захват сообщений из сельскохозяйственных чатов, их хранение в базе данных и пересылку в сервис-обработчик для обработки.

## Архитектура

Бот построен с использованием фреймворка `aiogram` и следует архитектуре на основе промежуточного ПО (middleware). Он состоит из следующих ключевых компонентов:

- **Основное приложение бота**: Инициализирует и запускает Telegram-бот
- **Сервис RabbitMQ**: Обрабатывает публикацию сообщений в очередь RabbitMQ
- **Репозиторий базы данных**: Управляет хранением сообщений в базе данных PostgreSQL
- **Таймеры чата**: Отслеживает неактивность чата и управляет действиями на основе таймера

## Ключевые файлы

- `main.py`: Точка входа для приложения бота
- `rabbit/service.py`: Сервис интеграции с RabbitMQ
- `db/repositories.py`: Репозиторий базы данных для хранения сообщений
- `middlewares.py`: Компоненты промежуточного ПО для обработки сообщений бота
- `timer.py`: Функциональность таймера неактивности чата
- `configs/config.py`: Настройки конфигурации

## Конфигурация

Бот настраивается через переменные окружения в файле `.env`:

| Переменная | Описание |
|----------|-------------|
| `BOT_TOKEN` | Токен API Telegram-бота |
| `DB_HOST` | Хост базы данных PostgreSQL |
| `DB_PORT` | Порт базы данных PostgreSQL |
| `DB_USER` | Имя пользователя базы данных PostgreSQL |
| `DB_PASSWORD` | Пароль базы данных PostgreSQL |
| `DB_NAME` | Имя базы данных PostgreSQL |
| `RABBITMQ_URL` | URL подключения к RabbitMQ |
| `RABBITMQ_MESSAGE_QUEUE` | Имя очереди RabbitMQ |

## Рабочий процесс

1. Бот запускается и подключается к API Telegram, базе данных PostgreSQL и RabbitMQ
2. Когда в чате получено сообщение, бот:
   - Регистрирует сообщение и его метаданные
   - Отправляет данные сообщения в RabbitMQ с помощью `RabbitMQService`
   - Сохраняет сообщение в базе данных с помощью `MessageRepository`
   - Сбрасывает таймер неактивности для чата

## Таймер неактивности

Бот включает систему таймеров, которая отслеживает неактивность в каждом чате. Это может использоваться для выполнения действий после периода неактивности, таких как:

- Отправка итоговых отчетов
- Напоминание пользователям о необходимости предоставить обновления
- Создание аналитики за период затишья

Таймер сбрасывается каждый раз, когда в чате получено новое сообщение.

## Добавление бота в новый чат

Чтобы добавить бота в новый сельскохозяйственный чат:
1. Пригласите пользователя-бота в группу Telegram
2. Предоставьте боту разрешение на чтение сообщений
3. Бот автоматически начнет обрабатывать сообщения 