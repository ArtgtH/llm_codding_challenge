# Компонент сервиса-обработчика

Сервис-обработчик отвечает за обработку сельскохозяйственных сообщений, извлечение структурированных данных с помощью ИИ и сохранение результатов как в Google Drive, так и в PostgreSQL.

## Архитектура

Обработчик состоит из следующих ключевых компонентов:

- **Потребитель сообщений**: Получает сообщения из RabbitMQ
- **ИИ-агент**: Обрабатывает текст сообщения с помощью Mistral AI для извлечения сельскохозяйственных операций
- **Загрузчик Google Drive**: Сохраняет документы в Google Drive
- **Репозиторий базы данных**: Хранит отчеты в PostgreSQL

## Ключевые файлы

- `main.py`: Точка входа для сервиса-обработчика
- `ai_agent/text_processing_pipeline.py`: Основной конвейер обработки текста
- `ai_agent/analysis_pipeline.py`: Анализ текста на основе ИИ с использованием Mistral AI
- `ai_agent/mistral_client.py`: Клиент для API Mistral AI
- `ai_agent/models/data_model.py`: Модели данных для сельскохозяйственных операций
- `google_drive/google_drive_uploader.py`: Функциональность загрузки в Google Drive
- `db/repositories.py`: Репозиторий базы данных для хранения отчетов

## Конфигурация

Обработчик настраивается через переменные окружения в файле `.env`:

| Переменная | Описание |
|----------|-------------|
| `MISTRAL_API_KEY` | Ключ API Mistral AI |
| `DB_HOST` | Хост базы данных PostgreSQL |
| `DB_PORT` | Порт базы данных PostgreSQL |
| `DB_USER` | Имя пользователя базы данных PostgreSQL |
| `DB_PASSWORD` | Пароль базы данных PostgreSQL |
| `DB_NAME` | Имя базы данных PostgreSQL |
| `RABBITMQ_URL` | URL подключения к RabbitMQ |
| `RABBITMQ_MESSAGE_QUEUE` | Имя очереди RabbitMQ |

## Рабочий процесс обработки сообщений

1. Обработчик получает сообщение из очереди RabbitMQ
2. Для каждого сообщения:
   - Исходный текст сохраняется как документ Word в Google Drive
   - Сообщение анализируется с помощью ИИ-агента для извлечения сельскохозяйственных операций
   - Извлеченные данные сохраняются в электронную таблицу Excel
   - Электронная таблица Excel загружается в Google Drive
   - Отчет Excel сохраняется в базе данных PostgreSQL

## ИИ-агент

ИИ-агент использует сервис Mistral AI для извлечения структурированных данных из неформальных сельскохозяйственных отчетов. Процесс включает:

1. Форматирование запроса с текстом сообщения и информацией о схеме
2. Отправку запроса в Mistral AI для анализа
3. Разбор и проверку возвращенных данных в формате JSON
4. Преобразование данных в объекты `AgriculturalOperation`

ИИ-агент может извлекать следующую информацию:
- Дата операций
- Сельскохозяйственное подразделение
- Тип сельскохозяйственной операции
- Тип культуры
- Ежедневная обработанная площадь
- Общая обработанная площадь
- Ежедневный урожай
- Общий урожай

## Интеграция с Google Drive

Обработчик сохраняет два типа документов в Google Drive:

1. **Документы Word**: Исходный текст сообщения
2. **Электронные таблицы Excel**: Структурированные данные, извлеченные из сообщений

Документы организованы по командам в папках и подпапках. 