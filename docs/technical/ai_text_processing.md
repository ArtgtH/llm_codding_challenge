# ИИ-обработка текста

В этом документе описывается функциональность обработки текста на основе ИИ, используемая для извлечения структурированных сельскохозяйственных данных из сообщений в свободной форме.

## Обзор

Система использует Mistral AI, большую языковую модель (LLM), для анализа сельскохозяйственных отчетов в свободном формате и извлечения структурированных данных о сельскохозяйственных операциях.

## Компоненты

### Конвейер обработки текста

Конвейер обработки текста (`text_processing_pipeline.py`) является основной точкой входа для обработки сообщений. Он:

1. Принимает текстовое сообщение в качестве входных данных
2. Передает его в конвейер анализа для обработки
3. Преобразует результаты в DataFrame
4. Добавляет новые данные в существующий файл Excel или создает новый
5. Возвращает обновленный файл Excel в виде байтов

### Конвейер анализа

Конвейер анализа (`analysis_pipeline.py`) обрабатывает основной ИИ-анализ:

1. Составляет подробный запрос для модели Mistral AI
2. Отправляет запрос в API Mistral AI
3. Разбирает и проверяет возвращенные данные JSON
4. Преобразует результаты в объекты `AgriculturalOperation`

### Клиент Mistral AI

Клиент Mistral AI (`mistral_client.py`) управляет взаимодействием с API Mistral AI:

1. Отправляет запросы в API Mistral
2. Обрабатывает ограничение скорости API
3. Обрабатывает ответ модели
4. Реализует обработку ошибок и повторные попытки

## Составление запроса

Запросы, отправляемые в Mistral AI, тщательно составлены для извлечения конкретной сельскохозяйственной информации:

1. **Определение задачи**: Четкие инструкции по извлечению сельскохозяйственных операций
2. **Правила и рекомендации**: Подробные правила для анализа различных типов данных
3. **Схема JSON**: Ожидаемый формат вывода
4. **Справочные списки**: Известные подразделения, операции и культуры
5. **Примеры**: Примеры входных и выходных данных для направления модели

## Извлечение данных

Система извлекает следующую информацию из сельскохозяйственных отчетов:

- **Дата**: Когда была выполнена операция
- **Подразделение**: Сельскохозяйственное подразделение, где выполнялась операция
- **Операция**: Тип сельскохозяйственной операции
- **Культура**: Обрабатываемая культура
- **Дневная площадь**: Площадь, обработанная в отчетный день
- **Общая площадь**: Совокупная обработанная площадь
- **Дневной урожай**: Урожай, собранный в отчетный день
- **Общий урожай**: Совокупный собранный урожай

## Ограничение скорости

Для предотвращения чрезмерного использования API система реализует ограничитель скорости (`utils/rate_limiter.py`), который:

1. Отслеживает частоту вызовов API
2. Применяет максимальное количество вызовов в минуту
3. Задерживает выполнение, если достигнут предел скорости

## Пример обработки

```
Ввод:
"""
30.03.25г.
СП Коломейцево

предпосевная культивация  
  -под подсолнечник
    день 30га
    от начала 187га(91%)

сев подсолнечника 
  день+ночь 57га
  от начала 157га(77%)
"""

Вывод:
[
  {
    "date": "2025-03-30",
    "subdivision": "СП Коломейцево",
    "operation": "Предпосевная культивация",
    "crop": "Подсолнечник товарный",
    "daily_area": 30.0,
    "total_area": 187.0,
    "daily_yield": null,
    "total_yield": null
  },
  {
    "date": "2025-03-30",
    "subdivision": "СП Коломейцево",
    "operation": "Сев",
    "crop": "Подсолнечник товарный",
    "daily_area": 57.0,
    "total_area": 157.0,
    "daily_yield": null,
    "total_yield": null
  }
] 