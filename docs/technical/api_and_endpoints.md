# API и конечные точки

В этом документе описываются API и конечные точки, используемые в приложении.

## Очередь сообщений RabbitMQ

RabbitMQ используется в качестве брокера сообщений между Telegram-ботом и сервисом-обработчиком.

### Конфигурация очереди

| Параметр | Значение |
|-----------|-------|
| Имя очереди | Настраивается через переменную окружения `RABBITMQ_MESSAGE_QUEUE` |
| Долговечность | `durable=True` |
| Автоматическое удаление | `False` |
| Эксклюзивность | `False` |

### Формат сообщений

Сообщения отправляются как объекты JSON со следующей структурой:

```json
{
  "chat_id": "123456789",
  "chat_title": "Группа сельскохозяйственных отчетов",
  "user": "Иван Иванов",
  "message_text": "Фактическое содержание сообщения...",
  "time": "15/04/2023, 14:30:45"
}
```

### Производитель (Telegram-бот)

Telegram-бот публикует сообщения в очередь в следующих случаях:
- Когда в чате получено новое сообщение
- Сообщение публикуется с использованием метода `RabbitMQService.send_message()`

### Потребитель (Сервис-обработчик)

Сервис-обработчик потребляет сообщения из очереди:
- Он использует блокирующее соединение с потреблением на основе канала
- Сообщения подтверждаются после успешной обработки
- Потребитель использует стандартную библиотеку `pika` для взаимодействия с RabbitMQ

## API Mistral AI

Сервис-обработчик использует API Mistral AI для анализа текста.

### Конфигурация API

| Параметр | Значение |
|-----------|-------|
| Ключ API | Настраивается через переменную окружения `MISTRAL_API_KEY` |
| Модель | "mistral-medium" |
| Температура | 0.3 |
| Максимальное количество токенов | 2048 |

### Формат запроса

Запросы к API Mistral AI включают:
- Тщательно составленный запрос с инструкциями и примерами
- Текст сообщения для анализа
- Параметры модели (температура, максимальное количество токенов и т.д.)

### Формат ответа

Ответы от API Mistral AI содержат:
- Структурированный список сельскохозяйственных операций в формате JSON
- Каждая операция сопоставляется с объектом `AgriculturalOperation`

## База данных PostgreSQL

Приложение использует PostgreSQL для хранения данных.

### Конфигурация подключения

| Параметр | Значение |
|-----------|-------|
| Хост | Настраивается через переменную окружения `DB_HOST` |
| Порт | Настраивается через переменную окружения `DB_PORT` |
| Имя пользователя | Настраивается через переменную окружения `DB_USER` |
| Пароль | Настраивается через переменную окружения `DB_PASSWORD` |
| Имя базы данных | Настраивается через переменную окружения `DB_NAME` |

### Таблицы

База данных имеет следующие таблицы:

1. `messages`: Хранит все сообщения, полученные Telegram-ботом
2. `daily_reports`: Хранит отчеты Excel, созданные сервисом-обработчиком 